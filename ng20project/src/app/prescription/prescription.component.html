<div id="prescription" class="container border p-4 bg-white">
  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Loading prescription...</p>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show">
    {{ errorMessage }}
    <button type="button" class="btn-close" (click)="errorMessage = ''" aria-label="Close"></button>
  </div>

  <!-- Prescription Content -->
  <div *ngIf="!isLoading">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <img src="https://i.postimg.cc/Jh6NpCt7/Copilot-20251007-094058.png" style="height: 48px; margin-right: 16px;" alt="SwasthaTech Logo">
      <h3 class="text-center flex-grow-1">SwasthaTech Hospital</h3>
      <div class="text-end">
        <strong>Dr. {{ doctor.name || 'N/A' }}</strong><br>
        <small>{{ doctor.info || 'N/A' }}</small><br>
        <small>HPID: {{ doctor.hpid || 'N/A' }}</small>
      </div>
    </div>

    <hr>

    <!-- Patient Info -->
    <div class="row mb-3">
      <div class="col-md-4"><strong>Patient Name:</strong> {{ patient.name || 'N/A' }}</div>
      <div class="col-md-2"><strong>Age:</strong> {{ patient.age || 0 }}</div>
      <div class="col-md-2"><strong>Gender:</strong> {{ patient.gender || 'N/A' }}</div>
      <div class="col-md-4"><strong>Date:</strong> {{ patient.date ? (patient.date | date:'shortDate') : 'N/A' }}</div>
    </div>

    <!-- Chief Complaints -->
    <div class="mb-3">
      <label class="form-label"><strong>Chief Complaints & History:</strong></label>
      <textarea 
        class="form-control" 
        [(ngModel)]="chiefComplaints" 
        [readonly]="!isEditMode" 
        placeholder="Enter chief complaints and history..."
        rows="3"
      ></textarea>
    </div>

    <!-- Past History -->
    <div class="mb-3">
      <label class="form-label"><strong>Past History:</strong></label>
      <textarea 
        class="form-control" 
        [(ngModel)]="pastHistory" 
        [readonly]="!isEditMode" 
        placeholder="Enter past medical history..."
        rows="3"
      ></textarea>
    </div>

    <!-- Examination -->
    <div class="mb-3">
      <label class="form-label"><strong>Examination:</strong></label>
      <textarea 
        class="form-control" 
        [(ngModel)]="examination" 
        [readonly]="!isEditMode" 
        placeholder="Enter examination findings..."
        rows="3"
      ></textarea>
    </div>

    <!-- Medicines Table -->
    <div class="mb-3">
      <h5>Medicines Prescribed:</h5>
      <div class="table-responsive">
        <table class="table table-bordered text-center">
          <thead class="table-light">
            <tr>
              <th rowspan="2">Sl. No</th>
              <th rowspan="2">Medicine Name</th>
              <th colspan="2">Morning</th>
              <th colspan="2">Afternoon</th>
              <th colspan="2">Night</th>
              <th rowspan="2">Days</th>
              <th rowspan="2" *ngIf="isEditMode">Action</th>
            </tr>
            <tr>
              <th>Before</th><th>After</th>
              <th>Before</th><th>After</th>
              <th>Before</th><th>After</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let med of medicines; let i = index">
              <td>{{ i + 1 }}</td>
              <td>
                <input 
                  class="form-control" 
                  [(ngModel)]="med.name" 
                  [readonly]="!isEditMode" 
                  placeholder="Medicine name"
                >
              </td>
              <td><input type="number" class="form-control" [(ngModel)]="med.morningBefore" [readonly]="!isEditMode" min="0"></td>
              <td><input type="number" class="form-control" [(ngModel)]="med.morningAfter" [readonly]="!isEditMode" min="0"></td>
              <td><input type="number" class="form-control" [(ngModel)]="med.afternoonBefore" [readonly]="!isEditMode" min="0"></td>
              <td><input type="number" class="form-control" [(ngModel)]="med.afternoonAfter" [readonly]="!isEditMode" min="0"></td>
              <td><input type="number" class="form-control" [(ngModel)]="med.nightBefore" [readonly]="!isEditMode" min="0"></td>
              <td><input type="number" class="form-control" [(ngModel)]="med.nightAfter" [readonly]="!isEditMode" min="0"></td>
              <td><input type="number" class="form-control" [(ngModel)]="med.days" [readonly]="!isEditMode" min="0"></td>
              <td *ngIf="isEditMode">
                <button class="btn btn-danger btn-sm" (click)="removeMedicine(i)">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <button *ngIf="isEditMode" class="btn btn-outline-primary btn-sm" (click)="addMedicine()">
        <i class="bi bi-plus-circle me-1"></i>Add Medicine
      </button>
    </div>

    <!-- Advice -->
    <div class="mb-3">
      <label class="form-label"><strong>Advice & Follow-Up:</strong></label>
      <textarea 
        class="form-control" 
        [(ngModel)]="advice" 
        [readonly]="!isEditMode" 
        placeholder="Enter advice and follow-up instructions..."
        rows="3"
      ></textarea>
    </div>

    <!-- Invoice Amount (only in create mode) -->
    <div class="mb-3" *ngIf="mode === 'create' && isEditMode">
      <label class="form-label"><strong>Invoice Amount (â‚¹): *</strong></label>
      <input 
        type="number" 
        class="form-control" 
        [(ngModel)]="invoiceAmount" 
        placeholder="Enter consultation fees"
        min="0"
        step="0.01"
        required
      >
      <small class="text-muted">This amount will be charged to the patient upon completion.</small>
    </div>

    <hr>

    <!-- Doctor Signature -->
    <div class="text-end mb-3">
      <p class="mb-0"><strong>Dr. {{ doctor.name || 'N/A' }}</strong></p>
      <p class="mb-0"><small>{{ doctor.info || 'N/A' }}</small></p>
    </div>

    <!-- Hospital Footer -->
    <div class="text-center text-muted">
      <h5>SwasthaTech Hospital</h5>
      <p class="mb-0">Bellandur, Bengaluru - 560103</p>
      <p>+91 8888666623 | swasthatech@gmail.com</p>
    </div>
  </div>
</div>

<!-- Action Buttons -->
<div class="mt-3 d-flex gap-2" *ngIf="!isLoading">
  <!-- View Mode -->
  <button class="btn btn-primary" *ngIf="!isEditMode && mode === 'view'" (click)="enableEdit()">
    <i class="bi bi-pencil me-1"></i>Edit
  </button>

  <!-- Edit Mode -->
  <button 
    class="btn btn-success" 
    *ngIf="isEditMode && mode === 'create'" 
    (click)="savePrescription()"
    [disabled]="isLoading"
  >
    <i class="bi bi-check-circle me-1"></i>Complete Appointment
  </button>

  <button 
    class="btn btn-success" 
    *ngIf="isEditMode && mode === 'view'" 
    (click)="savePrescription()"
    [disabled]="isLoading"
  >
    <i class="bi bi-save me-1"></i>Save Changes
  </button>

  <button 
    class="btn btn-secondary" 
    *ngIf="isEditMode" 
    (click)="cancelEdit()"
    [disabled]="isLoading"
  >
    <i class="bi bi-x-circle me-1"></i>Cancel
  </button>

  <!-- Download Button (always available) -->
  <button class="btn btn-outline-dark ms-auto" (click)="downloadPDF()">
    <i class="bi bi-download me-1"></i>Download PDF
  </button>
</div>